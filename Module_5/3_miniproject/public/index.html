<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Car Shop</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <style>
      .todoCompleted { text-decoration: line-through; }
      .card { width: 18rem; }
    </style>
  </head>
  <body>
    <!-- Template for each cart item, we will clone it for every item -->
    <template id="todoTemplate">
      <div class="card">
        <div class="card-body">
          <h5 id="todoTitle"></h5>
          <p id="toDoDesc" class="mb-2"></p>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="isCompleted" />
            <label class="form-check-label">Is completed</label>
          </div>
          <button id="toDoDel" class="btn btn-danger btn-sm">Del</button>
          <button id="toDoUpdate" class="btn btn-primary btn-sm">Update</button>
        </div>
      </div>
    </template>
<!--page layout and logo-->
    <div class="container py-3">
      <img src="./assets/logo.png" width="40" alt="logo" />
      <h1 class="mt-2">Car shop:</h1>

      <!-- Form -->
      <form onsubmit="todoSubmit(event)" class="mt-3">
        <!-- Title as a selector of items to add to the cart -->
        <div class="mb-3">
          <label for="todoTitleSelect" class="form-label">Title</label>
          <select class="form-control" id="todoTitleSelect">
            <option value="">Choose an item…</option>
            <option value="1" data-title="Tesla car" data-price="1000">
              Id 1 — Tesla car — $1000
            </option>
            <option value="2" data-title="BMW car" data-price="2000">
              Id 2 — BMW car — $2000
            </option>
          </select>
        </div>

        <!-- Cart total display -->
        <div class="mb-3">
          <label for="todoDesc" class="form-label">Cart total</label>
          <input
            type="text"
            class="form-control"
            id="todoDesc"
            value="Cart total: $0.00"
            readonly
          />
        </div>

        <!--Button to display cart -->
        <button type="submit" class="btn btn-primary">Cart</button>
      </form>
        <!--container where cards are rendered -->
      <div class="row mt-4 g-3" id="todoContainer"></div>

      <!-- Your modal -->
      <div
        class="modal fade"
        id="exampleModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel">Welcome</h1>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              Select an item from the Title list to add it to your cart.
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>

    <script>
      // -------------------------
      // State and helpers
      // -------------------------
      let todos = [];           // items returned from the server
      let cartTotal = 0;

      const money = (n) => //to get a properly formatted follar amount
        new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(n);

      // Map titles to prices for inference when price is not present on older rows
      const TITLE_PRICE = {
        "tesla car": 1000,
        "bmw car": 2000,
      };

      function priceOf(todo) {
        if (typeof todo.price === "number") return todo.price;
        const title = (todo.title || "").toLowerCase();
        return TITLE_PRICE[title] || 0;
      } //Looks up the price from a predefined object called TITLE_PRICE using the title as the key. If the title is not found in TITLE_PRICE, it returns 0 as a fallback.

      function updateCartDisplay() { // Write the current total to the read-only "Cart total" input.
        document.getElementById("todoDesc").value = "Cart total: " + money(cartTotal);
      }

      function recomputeCartTotal() { //// Recalculate total from the "todos" array (used after deletes or initial load).
        cartTotal = todos.reduce((sum, t) => sum + priceOf(t), 0);
        updateCartDisplay();
      }

    
      // Rendering
      // Render a single item card using the <template>.
      function displayTodo(todo, index) {
        const { id, title, desc, isCompleted } = todo;
        const frag = document.getElementById("todoTemplate").content.cloneNode(true);
        //frag is a reusable template clone that allows you to quickly build a fully populated to-do card (with title, description, price, and delete button) in memory, and then insert it into the page.
        // Insert data into the cloned nodes.
        frag.querySelector("#todoTitle").innerText = title;
        frag.querySelector("#toDoDesc").innerText = desc || ("Price: " + money(priceOf(todo)));
        frag.querySelector("#isCompleted").checked = !!isCompleted;

        if (isCompleted) {
          frag.querySelector("#todoTitle").classList.add("todoCompleted");
          frag.querySelector("#toDoDesc").classList.add("todoCompleted");
        }

        // Delete: remove on server, then update local list and total
        frag.querySelector("#toDoDel").addEventListener("click", () => {
          fetch(`/api/todos/${id}`, { method: "DELETE" })
            .then((res) => {
              if (!res.ok && res.status !== 204) throw new Error("Delete failed");
              todos.splice(index, 1);
              recomputeCartTotal();   // update total after delete
              renderTodos();
            })
            .catch(console.error);
        });

        // Optional: keep your PUT logic
        frag.querySelector("#isCompleted").addEventListener("click", (event) => {
          const nextCompleted = event.target.checked;
          fetch(`/api/todos/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, desc, isCompleted: nextCompleted, price: priceOf(todo) }),
          })
            .then((r) => r.json())
            .then((data) => {
              todos.splice(index, 1, data);
              renderTodos();
            });
        });
         // Wrap the card in a grid column and append into the grid container.
        const col = document.createElement("div");
        col.className = "col-auto";
        col.appendChild(frag);
        document.getElementById("todoContainer").appendChild(col);
      }
      // Render all items: clear the container and draw each card.
      function renderTodos() {
        document.getElementById("todoContainer").innerHTML = "";
        todos.forEach((t, i) => displayTodo(t, i));
      }

      // Add item to cart by selecting from Title
      // When the user chooses Tesla or BMW in the select,
      // create a new item, send it to the backend, and update the UI.
      document.getElementById("todoTitleSelect").addEventListener("change", (e) => {
        const opt = e.target.selectedOptions[0];
        const title = opt?.dataset?.title;
        const price = Number(opt?.dataset?.price || 0);
        if (!title || !price) return;

        const todo = { title, desc: `Price: ${money(price)}`, price };
        // Persist to backend, then update local state and UI.
        fetch("/api/todos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(todo),
        })
          .then((r) => r.json())
          .then((created) => {
            todos.push(created);
            cartTotal += price;       // increment quickly
            updateCartDisplay();
            renderTodos();
            e.target.selectedIndex = 0; // allow quick re-selection
          })
          .catch(console.error);
      });

      
      // Submit keeps a summary row (optional)
      function todoSubmit(event) {
        event.preventDefault();
        const summary = { title: "Cart summary", desc: document.getElementById("todoDesc").value };
        fetch("/api/todos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(summary),
        })
          .then((r) => r.json())
          .then((created) => {
            todos.push(created);
            renderTodos();
          })
          .catch(console.error);
      }

      // Initial load
      // Get all saved items from the backend.
      async function getInitData() {
        const r = await fetch("/api/todos");
        return r.json();
      }
      // Load, compute total based on existing items, and render them.
      async function displayInitTodos() {
        todos = await getInitData();
        recomputeCartTotal();  // compute from existing items
        renderTodos();
      }

      displayInitTodos();

      // Instantiate and show your Bootstrap modal on first load.
      const myModal = new bootstrap.Modal(document.getElementById("exampleModal"));
      myModal.show();
    </script>
  </body>
</html>
